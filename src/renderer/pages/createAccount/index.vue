<template>
  <section class="init">
    <section class="type">{{$t('label.type')}}</section>
    <section class="radio-groups">
      <el-radio-group v-model="radio" @change="changeType()">
        <el-radio :label="'wallet'">{{$t('title.walletType')}}</el-radio>
        <el-radio :label="'account'">{{$t('title.accountType')}}</el-radio>
      </el-radio-group>
    </section>
    <el-form ref="form" :model="formData" :rules="formRules" class="mt20">
      <el-form-item prop="account">
        <section class="type">{{$t('label.account')}}</section>
        <el-input
          class="no-border"
          v-model="formData.account"
          type="text"
          :placeholder="$t('verify.accountType')"
        ></el-input>
      </el-form-item>
      <el-form-item prop="password">
        <section class="type">{{$t('label.password')}}</section>
        <el-input
          class="no-border"
          v-model="formData.password"
          type="password"
          :placeholder="$t('verify.passwordType')"
        ></el-input>
      </el-form-item>
      <el-form-item prop="repassword">
        <section class="type">{{$t('placeholder.repassword')}}</section>
        <el-input
          class="no-border"
          v-model="formData.repassword"
          type="password"
          :placeholder="$t('placeholder.repassword')"
        ></el-input>
      </el-form-item>
      <el-form-item class="mt40" style="margin-bottom:0">
        <el-button
          class="full-btn height-button"
          type="primary"
          @click="createWallet('form')"
          :disabled="!formData.account || !formData.password || !formData.repassword"
        >{{$t('button.create')}}</el-button>
      </el-form-item>
    </el-form>
    <section
      v-if="radio === 'wallet'"
      class="small-tip text-center red mt30"
    >{{$t('message.wallet')}}</section>
    <section v-if="radio === 'account'" class="text-center red mt20">{{$t('message.account')}}</section>
  </section>
</template>
<script>
import { mapState, mapMutations, mapActions } from "vuex";
import Navigation from "../../components/navigation";
import SocketService from "../../services/socketService";
import Cocos from "../../models/cocos";
import { setTimeout } from "timers";
export default {
  components: {
    Navigation
  },
  data() {
    const validatePass = (rule, value, callback) => {
      let reg = /^(?![\d]+$)(?![a-zA-Z]+$)(?![^\da-zA-Z]+$).{8,12}$/;
      if (value === "") {
        if (this.changeRadio) {
          this.setChangeRadio(false);
          return;
        }
        this.$kalert({
          message: this.$i18n.t("verify.passwordNull")
        });
        callback(new Error());
      } else if (!reg.test(value)) {
        if (this.changeRadio) {
          this.setChangeRadio(false);
          return;
        }
        this.$kalert({
          message: this.$i18n.t("verify.passwordType")
        });
        callback(new Error());
      } else {
        callback();
      }
    };
    const accountPass = (rule, value, callback) => {
      let reg = /^[a-z]([a-z0-9\.-]){4,63}$/;
      if (value === "") {
        if (this.changeRadio) {
          this.setChangeRadio(false);
          return;
        }
        this.$kalert({
          message: this.$i18n.t("verify.accountNull")
        });
        callback(new Error());
      } else if (!reg.test(value)) {
        if (this.changeRadio) {
          this.setChangeRadio(false);
          return;
        }
        this.$kalert({
          message: this.$i18n.t("verify.accountType")
        });
        callback(new Error());
      } else {
        callback();
      }
    };
    const validatePass2 = (rule, value, callback) => {
      if (value === "") {
        if (this.changeRadio) {
          this.setChangeRadio(false);
          return;
        }
        this.$kalert({
          message: this.$i18n.t("verify.passwordSure")
        });
        callback(new Error());
      } else if (value !== this.formData.password) {
        if (this.changeRadio) {
          this.setChangeRadio(false);
          return;
        }
        this.$kalert({
          message: this.$i18n.t("verify.passwordMatch")
        });
        callback(new Error());
      } else {
        callback();
      }
    };
    return {
      radio: "wallet",
      wallet: null,
      lang: "zh",
      formData: {
        account: "",
        password: ""
        // repassword: ""
      },
      formRules: {
        account: [{ validator: accountPass, trigger: "blur" }],
        password: [{ validator: validatePass, trigger: "blur" }],
        repassword: [{ validator: validatePass2, trigger: "blur" }]
      }
    };
  },
  computed: {
    ...mapState(["accounts", "passwords", "accountType", "cocos"])
  },
  methods: {
    ...mapMutations([
      "setCurLng",
      "setAccountType",
      "setCurrentAccount",
      "setLogin",
      "setIsLocked",
      "settemporaryKeys",
      "setKeys",
      "setChangeRadio",
      "setCocos",
      "loading"
    ]),
    ...mapMutations("common", [
      "WalletRegister"
    ]),
    ...mapActions("account", [
      "logoutBCXAccount",
      "OutPutKey"
    ]),
    ...mapActions("wallet", [
      "createAccountWithWallet",
      "createAccountWithPassword",
      "importPrivateKey",
      "OutWalletPutKey"
    ]),
    createWallet(formName) {
      this.$refs[formName].validate(valid => {
        if (valid) {
         let createParams = {
              account: this.formData.account,
              password: this.formData.password
          }
          if (this.radio === "account") {
            this.createAccountWithPassword(createParams).then(res => { 
              console.log("createAccountWithPassword",res);
              if (res.code === 1) {
                this.setLogin(true);
                this.setIsLocked(false)
                this.setCurrentAccount(res.data.account_name)
                this.setAccountType(res.data.mode)
                this.WalletRegister(false);
                this.$router.push({ name: "home" });
               
                // SocketService.initialize();
              
                // if (!this.cocos) {
                //   const cocos = Cocos.placeholder();
                //   this.setCocos(cocos);
                // } else if (!(this.cocos instanceof Cocos)) {
                //   let sfj = JSON.parse(JSON.stringify(this.cocos));
                //   const cocos = Cocos.fromJson(sfj);
                //   this.setCocos(cocos);
                // }
                
                // this.OutPutKey().then(key => {
                //   if (key.code === 1) {
                //     this.settemporaryKeys(key.data.active_private_keys);
                //     this.setKeys(key.data.owner_private_keys);
                //     this.privateStore(true);
                //   }
                // });
              }
            });
            return;
          } 
          this.createAccountWithWallet(createParams).then(res => {
              console.log("createAccountWithWallet",res);
              if (res.code === 1) {
                this.setLogin(true);
                this.setIsLocked(false)
                this.WalletRegister(false);
                this.setCurrentAccount(res.data.account_name)
                this.setAccountType(res.data.mode)
                this.$router.push({ name: "home" });
              }else{

              }
            });
        }
      });
    },
    changeType() {
      this.setChangeRadio(true);
    },
    noAlert() {
      if (this.changeRadio) {
        this.setChangeRadio(false);
        return;
      }
    }
  }
};
</script>
<style lang="scss" scoped>
.init {
  .el-input {
    margin-top: 14px !important;
  }
}
.type {
  font-size: 16px;
  color: rgba(96, 97, 101, 1);
  line-height: 22px;
}
.radio-groups {
  margin-top: 16px;
}
.select-lang {
  display: flex;
  justify-content: flex-end;
  align-items: center;
  height: 50px;
}
.index-title {
  font-size: 30px;
  margin: 25px auto 40px;
}
</style>
